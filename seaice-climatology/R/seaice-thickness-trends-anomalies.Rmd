---
title: "subset-polar-data-with-shapefile"
author: "Sunny Hospital"
date: "`r Sys.Date()`"
output: html_document
---

# https://rspatial.org/spatial/index.html

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Function to check if pkgs are installed, install missing pkgs, and load

pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,dep=TRUE,repos='http://cran.us.r-project.org')
    if(!require(x,character.only = TRUE)) stop(x, " :Package not found")
  }
}

list.of.packages <- c("sp", "ggplot2" , "rerddap", "RColorBrewer", "scales", "reshape2", "ncdf4")

# create list of installed packages
pkges = installed.packages()[,"Package"]
for (pk in list.of.packages) {
  pkgTest(pk)
}
```
## Calculating anomaly and trend with sea ice thickness time series
In this exercise, we will use the sea ice thickness data in the Arctic region, available through the PolarWatch data server, to study changes in monthly average sea ice thickness values. We will compare the current state of sea ice thickness to the historical mean and also evaluate the long-term trend from the data.

### The exercise demonstrates the following techniques:
- Loading twice daily sea ice thickness data of the year 2023 from ERDDAP using `xarray` and compute monthly average
- Loading multi-year monthly average sea ice thickness data from netCDF file
- Calculating the trend of monthly sea ice thickness means for the climatological reference period of 2006 to 2020 (15 years)
- Calculating historical average of the reference period (2006-2020)
- Calculating anomalies (departures from the historical mean)
- Visualizing the data 

### Datasets used:
Sea ice thickness for the Arctic from the NOAA Climate Data Record (CDR) of the Extended Polar Pathfinder cryosphere dataset from NCEI. Twice daily data are available from 1982 to present. [https://polarwatch.noaa.gov/catalog/ice-thick-sq-nh-appx/preview/](https://polarwatch.noaa.gov/catalog/ice-thick-sq-nh-appx/preview/)

25-km sea ice thickess monthly average data from 2006 to 2020.

_In this exercise, monthly means were computed from the 25-km sea ice thickness dataset under the assumption of equal sampling and no missing data. Therefore, no weights were applied in this instance. In cases where data gaps or uneven sampling occur, applying appropriate weights is recommended for more accurate climatological calculations._

### Load libraries

```{r}
library(terra)
library(sf)
library(ggplot2)
library(rerddap)
library(RColorBrewer)
library(scales)
library(ncdf4)
library(lubridate)
library(dplyr)
library(ncdf4)
library(lattice)
```


## Set up ERDDAP data request

We will begin by obtaining the current sea ice thickness data from the PolarWatch ERDDAP data server. The data request is made using a URL that includes the ERDDAP address and a unique dataset ID.

```{r erddap_data}

pw_url = "https://polarwatch.noaa.gov/erddap/"
dataset_id = "ncei_polarAPPX20_nhem"
var_name = "cdr_sea_ice_thickness"
dat_info <- info(datasetid = dataset_id, url = pw_url)
dat_info
```
### Load Sea ice thickness data
```{r}

# Request data with specific time range and variable
dat <- griddap(dat_info,  time = c('2023-01-01','2023-12-23'), fields = var_name)

# Extract data from the gripddap object
seaice <- dat$data
```

### Compute monthly mean from daily data

```{r}
# Parse date/time
seaice$time <- ymd_hms(seaice$time)

# Create year and month columns
seaice <- seaice %>%
  mutate(year = year(time),
         month = month(time))

# Compute monthly mean for each grid
monthly_mean23<- seaice %>%
  group_by(year, month, rows, columns) %>%
  summarise(cdr_sea_ice_thickness = mean(cdr_sea_ice_thickness, na.rm = TRUE))

# Display monthly mean for Jan
monthly_mean23[monthly_mean23$month == 1,]
```


# Visualize the monthly mean on the map 

```{r, eval=FALSE }
# Visualize the data (warning: this takes awhile to )
ggplot(data = monthly_mean[monthly_mean$month == 1,], aes(x = columns, y = rows, fill=cdr_sea_ice_thickness)) +
         geom_tile() + 
         coord_fixed(ratio = 1) + 
         scale_y_continuous() + 
         scale_x_continuous() +
         scale_fill_gradientn(colours=rev(brewer.pal(n = 3, name = "Blues")),na.value="tan") +
         ggtitle("2023 Seaice thickness monthly mean (Januarary)")

```

### Load monthly average from 2006 to 2020

To do climate analysis such as computing climatology and trend analysis, we will use sea ice thickness monthly average from 2005 to 2020. The monthly averages are already computed and are available in netcdf file.

```{r}

fname <- "../data/combined_climatology_2006_2020.nc"
ncin <- nc_open(fname)
print(ncin)
```

Dimensions: year, month, rows, columns
variable: cdr_sea_ice_thickness
```{r}

cols = ncvar_get(ncin, "columns")
rows = ncvar_get(ncin, "rows")
sit <- ncvar_get(ncin,"cdr_sea_ice_thickness")
```


### Visualize the monthly data

```{r}

# View dimension of the data
dim(sit)  # [columns,rows,month,year]

# Subset first month of first year
onestep <- sit[,,1,1]

# You can also visualize data array using terra:image function  
image(cols, rows, onestep, col=c(rgb(1,1,1),brewer.pal(9,"Blues"))  )

```

### Compute the 15 year historical mean
```{r}
library(reshape2) 
# Compute monthly average over years
hist_monthly_means <- apply(sit, c(1, 2, 3), mean, na.rm = TRUE )

# Check dimension
dim(hist_monthly_means)

# Visualize historical monthly average using ggplot
# First convert to data.frame
df <- melt(hist_monthly_means[,,1], varnames = c("cols", "rows"), value.name = "sit")

# Visualize 
ggplot(data = df , aes(x = cols, y = rows, fill=sit)) +
         geom_tile() + 
         coord_fixed(ratio = 1) + 
         scale_y_continuous() + 
         scale_x_continuous() +
         scale_fill_gradientn(colours=rev(brewer.pal(n = 3, name = "Blues")),na.value="tan") +
         ggtitle("2023 Seaice thickness monthly mean (Januarary)")

image(cols, rows, hist_monthly_means[,,9] , col=c(rgb(1,1,1),brewer.pal(9,"Blues"))  )

```

### Compute anomaly

To understand the recent change in the sea ice thickness, we can compare the current state (year 2021) to the historical mean. Anomaly is a commonly used metric representing the difference (or departure).

```{r}

```


## Climatology

```{r}
# Function to format the time into year and month columns
format_year_month <- function(dat) {
  dat$time <- ymd_hms(dat$time)  # Convert the time column to date-time format
  
  dat %>%
    mutate(year = year(time),    # Extract year
           month = month(time))  # Extract month
}

# Function to compute the monthly mean for each grid
compute_monthly_mean <- function(dat) {
  dat %>%
    group_by(year, month, rows, columns) %>%  # Group by year, month, and spatial dimensions
    summarise(cdr_sea_ice_thickness = mean(cdr_sea_ice_thickness, na.rm = TRUE))  # Calculate monthly mean
}

# Define your griddap query in a function to handle each time range
query_griddap <- function(start_date, end_date) {
  time_range = c(as.character(start_date), as.character(end_date))
  dat_obj <- griddap(dat_info, 
          time = time_range,   # Use the provided time range
          fields = var_name)
  dat_obj$data %>%
    format_year_month() %>%    # Format the time to year/month
    compute_monthly_mean()         # Compute the monthly mean
}


plan(multisession)  # Set up parallel processing

results <- future_map(1:nrow(time_intervals), function(i) {
  query_griddap(time_intervals$start[i], time_intervals$end[i])
})


# Combine results if necessary (assuming the results are data frames)
combined_results <- bind_rows(results)

# Print the combined results
print(combined_results)
summary(combined_results)

```


```{r}
# Visualize the data (warning: this takes awhile to )
ggplot(data = combined_results[combined_results$month == 9 & combined_results$year == 2020,], aes(x = columns, y = rows, fill=cdr_sea_ice_thickness)) +
         geom_tile() + 
         coord_fixed(ratio = 1) + 
         scale_y_continuous() + 
         scale_x_continuous() +
         scale_fill_gradientn(colours=rev(brewer.pal(n = 3, name = "Blues")),na.value="tan") +
         ggtitle("Monthly Seaice thickness")

```



