---
title: "subset-polar-data-with-shapefile"
author: "Sunny Hospital"
date: "`r Sys.Date()`"
output: html_document
---

# https://rspatial.org/spatial/index.html

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Function to check if pkgs are installed, install missing pkgs, and load

pkgTest <- function(x)
{
  if (!require(x,character.only = TRUE))
  {
    install.packages(x,dep=TRUE,repos='http://cran.us.r-project.org')
    if(!require(x,character.only = TRUE)) stop(x, " :Package not found")
  }
}

list.of.packages <- c("sp", "ggplot2" , "rerddap", "RColorBrewer", "scales", "reshape2", "ncdf4")

# create list of installed packages
pkges = installed.packages()[,"Package"]
for (pk in list.of.packages) {
  pkgTest(pk)
}
```


### The exercise demonstrates the following techniques:
- Loading twice daily sea ice thickness data of the year 2023 from ERDDAP using `xarray` and compute monthly average
- Loading multi-year monthly average sea ice thickness data from netCDF file
- Calculating the trend of monthly sea ice thickness means for the climatological reference period of 2006 to 2020 (15 years)
- Calculating historical average of the reference period (2006-2020)
- Calculating anomalies (departures from the historical mean)
- Visualizing the data 


```{r}
library(terra)
library(sf)
library(ggplot2)
library(rerddap)
library(RColorBrewer)
library(scales)
library(ncdf4)
library(lubridate)
library(dplyr)


```


## Load IMS Sea ice data 

```{r erddap_data}

pw_url = "https://polarwatch.noaa.gov/erddap/"
dataset_id = "ncei_polarAPPX20_nhem"
var_name = "cdr_sea_ice_thickness"
dat_info <- info(datasetid = dataset_id, url = pw_url)
dat_info
```

```{r}
dat <- griddap(dat_info,  time = c('2023-01-01','2023-12-23'), fields = var_name)
seaice <- dat$data

seaice$time <- ymd_hms(seaice$time)

seaice <- seaice %>%
  mutate(year = year(time),
         month = month(time))

monthly_seaice <- seaice %>%
  group_by(year, month, rows, columns) %>%
  summarise(cdr_sea_ice_thickness = mean(cdr_sea_ice_thickness, na.rm = TRUE))
monthly_seaice
monthly_seaice[monthly_seaice$month == 1,]
```


# Visualize the sea ice thickness 2023, January satellite data

```{r, eval=FALSE }
# Visualize the data (warning: this takes awhile to )
ggplot(data = monthly_seaice[monthly_seaice$month == 1,], aes(x = columns, y = rows, fill=cdr_sea_ice_thickness)) +
         geom_tile() + 
         coord_fixed(ratio = 1) + 
         scale_y_continuous() + 
         scale_x_continuous() +
         scale_fill_gradientn(colours=rev(brewer.pal(n = 3, name = "Blues")),na.value="tan") +
         ggtitle("Seaice thickness")

```

## Loading 20 year monthly average sea ice thickness 

```{r}

library(ncdf4)

his_monthly <- nc_open('../hist_clm_15_20.nc')
his_monthly

mon <- ncvar_get(his_monthly, "month")
yr <- ncvar_get(his_monthly, "year")
rows <- ncvar_get(his_monthly, "rows")
columns <- ncvar_get(his_monthly, "columns")
sit <- ncvar_get(his_monthly, "cdr_sea_ice_thickness")
nc_close(his_monthly)            
sit_aug_2016 <- sit[, , 8, 2]
sit_aug_2016

rows <- 1:length(rows)
columns <- 1:length(columns)
grid <- expand.grid(row = rows, column = columns)

his_month_df <- data.frame(
  rows = grid$rows,
  columns = grid$columns,
  cdr_sea_ice_thickness = as.vector(sit_aug_2016)
)              
            
dim(sit)

his_jan <-his_month_df[his_month_df$year == 2016 & his_month_df$month == 8,]

unique(his_jan$month)
# Visualize the data (warning: this takes awhile to )
ggplot(data = his_jan, aes(x = columns, y = rows, fill=cdr_sea_ice_thickness)) +
         geom_tile() + 
         coord_fixed(ratio = 1) + 
         scale_y_continuous() + 
         scale_x_continuous() +
         scale_fill_gradientn(colours=rev(brewer.pal(n = 3, name = "Blues")),na.value="tan") +
         ggtitle("Seaice thickness")

```
# Visualize loaded historical mean data

```{r, eval=FALSE }
# Visualize the data (warning: this takes awhile to )
ggplot(data = his_jan, aes(x = columns, y = rows, fill=cdr_sea_ice_thickness)) +
         geom_tile() + 
         coord_fixed(ratio = 1) + 
         scale_y_continuous() + 
         scale_x_continuous() +
         scale_fill_gradientn(colours=rev(brewer.pal(n = 3, name = "Blues")),na.value="tan") +
         ggtitle("Seaice thickness")

```

# Compute the 20 year historical mean

```{r compute_historical_mean}

clm_mean <- his_month_df %>%
  group_by(month, rows, columns) %>%
  summarise(cdr_sea_ice_thickness = mean(cdr_sea_ice_thickness, na.rm = TRUE))

clm_mean

```

# Visualize the 20 year historical mean (Jan)


```{r, eval=FALSE }
# Visualize the data (warning: this takes awhile to )
ggplot(data = clm_mean[clm_mean$month == 1,], aes(x = columns, y = rows, fill=cdr_sea_ice_thickness)) +
         geom_tile() + 
         coord_fixed(ratio = 1) + 
         scale_y_continuous() + 
         scale_x_continuous() +
         scale_fill_gradientn(colours=rev(brewer.pal(n = 3, name = "Blues")),na.value="tan") +
         ggtitle("Seaice thickness")

nrow(clm_mean[clm_mean$month==1,])
```
